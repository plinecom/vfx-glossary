# EXR（いーえっくすあーる）

OpenEXRは画像形式の一つ。特徴としては、画像データを浮動小数で記録できる。コレによって非常に広いダイナミックレンジを有するため、画像加工を何度も繰り返しても劣化の影響が極めて小さい。

OpenEXRには様々な形でデータを記録することができるが、一般に使われるのは半精度浮動小数（16bit half float)で、圧縮形式はZIPが多い。

圧縮形式にはそれ以外にもいくつかあり、ZIP（縦１６ライン毎にZip圧縮）、ZIPS(縦１ライン毎にZip圧縮。SはスキャンラインのS)、PIZ(フーリエ変換の上位概念であるウェーブレット変換による圧縮。計算負荷が高い）等がある。どれを使うべきかは、大抵の場合、納品先から指定がある。ただ、よくわかっていない作業者が指定の圧縮形式以外、または非圧縮でデータを作ってしまうことがあるので困る。そう言う時にはシステムの人に助けてもらうと良い。

ガンマカーブは、そのダイナミックレンジの広さから、一般にリニアガンマ（ガンマ値１）が用いられる。（のだが、頻繁にsRGBのガンマで作っちゃうことがあって、事故が多発する。特にAdobe系のソフトで多発する）

色空間もその広大なデータ空間から、人間の認知可能な最大の色域を超える領域を扱えるACEsが用いられることが多い。（のだが、sRGBで作っちゃうことがAdobe系で多発しがち。事故る）

アルファチャンネルを含め任意の数のチャンネルを持てるため、3DCGのZ深度、法線マップ、スペキュラやアンビエントオクルージョンなどのレンダーレイヤーを一枚の画像ファイルにまとめることもできる。

CGやVFXに用いるメタデータ（タイムコードなど）を画像に一緒に記録することができるので、扱いやすい。

Industrial Light & Magic（ILM）が1999年に開発し、2003年にオープンソース化された

# OpenEXRの圧縮オプションについての解説

## 可逆（ロスレス）圧縮オプション

### RLE

ランレングス圧縮。単純な圧縮処理だが１パスで終わる上に計算量も少ないので非常に高速。非圧縮にするのと大差ない速度で書き出せる。これだけでも概ね９０％のサイズになるので、非圧縮を選ぶ理由がない。~~ので、非圧縮OpenEXRファイルなんか送ってくるな。~~と思っていたら納品先から非圧縮を指定されたことがあった。送出の際の処理時間の不確定性を排除したかった模様。

### ZIP

みなさんご存知ZIP圧縮。画像を１６ライン毎に区切って圧縮してくれる。これを使えば非圧縮の半分くらいのサイズにできる。

### ZIPS

ZIPでは16ライン毎に圧縮するが、ZIPSでは１ライン毎にZIP圧縮する。SはスキャンラインのS。複数形のSではない。Nukeなどのコンポジットソフトでは処理が速くなるという噂を聞いたが、体感できるほどの差を感じたことはない。ZIPよりは圧縮効率が落ちる。

### PIZ

ウエーブレット変換というフーリエ変換の上位互換的なものを使って、周波数領域に画像データを持っていって圧縮する。最高の圧縮率が出るものの、計算量も非常に大きい。ZIP圧縮よりさらに数％くらい小さくなる割には計算量の犠牲が大きすぎると思う。

## 可逆圧縮になったり非可逆圧縮になったりするもの

### PXR24

24bitに量子化を下げて圧縮する。24bit以下の16bit半精度浮動小数点データや16bit整数データならロスレスな可逆圧縮だが、32bit単精度浮動小数点データ等ではロッシーな非可逆圧縮となる。この点、取扱注意なので、よくわからないときは選ばない方がいい。

## 非可逆圧縮オプション

他に非可逆圧縮オプションとして以下のものがある。

- B44
- B44A
- DWAA
- DWAB

ただ、高品位を狙ってOpenEXR利用することがほとんどなのと、納品先で解凍結果が異なって事故る可能性のあるロッシーな非可逆圧縮は、あんまり使わないかなと思う。自社でマスターまで出す大規模スタジオならストレージ効率の面から選択肢に入るかもしれない。

開発者向け記事
[PythonでOpenEXRファイルの圧縮方法を変換する](https://qiita.com/plinecom/items/7fa526fb25cab3c53509)
[静止画(OpenEXR)の連番を動画にしたい。Pythonとffmpegで](https://qiita.com/plinecom/items/76ca4d912f89e24c2ce6)
[PythonでOpenImageIO(OIIO)を使ってOpenEXRをJPEGに変換する](https://qiita.com/plinecom/items/f5a0e63b1835f8e71338)
[PythonでOpenImageIO(OIIO)を使ってOpenEXR画像に3DLUTを焼き込む](https://qiita.com/plinecom/items/b8f672f98637c5948da5)
[PythonでOpenEXRファイルをチャンネル毎に分割する](https://qiita.com/plinecom/items/04b829ad796ec51c4e52)